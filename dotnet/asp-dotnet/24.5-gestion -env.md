# 24.5 gestion des diffÃ©rents environnements

## Â´DOTNET_ENVIRONMENTÂ´ et Â´ASPNETCORE_ENVIRONMENTÂ´
Il y a une prÃ©sÃ©ence de Â´DOTNET_ENVIRONMENTÂ´ sur Â´ASPNETCORE_ENVIRONMENTÂ´, le meilleur moyen de rÃ©gler ce genre de problÃ¨me est d'ajouter dans Â´LaucnSettings.jsonÂ´ les deux variables :
Â´Â´Â´json
"Test": {
      "commandName": "Project",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Test",
        "DOTNET_ENVIRONMENT": "Test"
      },
      "launchBrowser": false,
      "dotnetRunMessages": true,
      "applicationUrl": "https://localhost:6443;http://localhost:6080"
    },
Â´Â´Â´
    

## Plusieurs `appsettings.json`

On peut crÃ©er autant de `appsettings.json` que d'environnements qu'on dÃ©sire :

<img src="assets/all-appsettings-json-ceated-frqtyuj.png" alt="all-appsettings-json-ceated-frqtyuj" />

Si `ASPNETCORE_ENVIRONMENT` vaut `Test` par exemple, les valeurs de `appsettings.json` et `appsettings.Test.json` seront lues. Si une clÃ© est identique et prÃ©sente dans les deux fichiers, le plus spÃ©cifique Ã©crase le plus gÃ©nÃ©rique. Ici `appsettings.Test.json` Ã©crase `appsettings.json`.

`appsettings.json`

```json
{
  "MyConnectionString" : "Connection String de unknow ???",
  "AllowedHosts": "*",
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "MyStringForAll": "je suis disponible depuis tous les environnements"
}
```



`appsettings.Test.json`

```json
{
  "MyConnectionString" : "Connection String de Test"
}
```

Ici `Configuration["MyConnectionString"]` vaudra donc `"Connection String de Test"`.

### Test dans `Blazor Server`

```react
@page "/"

@inject IConfiguration Configuration


Connection string : @_connectionString<br/>
for all : @_forAll

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Test")
{
    <p>Je suis dans l'environnement de Test</p>
}

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development")
{
    <p>Je suis dans l'environnement de Development</p>
}

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Production")
{
    <p>Je suis dans l'environnement de Production</p>
}


@code
{
    string _connectionString = string.Empty;
    string _forAll = string.Empty;

    protected override void OnInitialized()
    {
        _connectionString = Configuration["MyConnectionString"] ?? "";
        _forAll = Configuration["MyStringForAll"] ?? "";
    }
}
```

<img src="assets/variouss-env-test-in-blazor-iaogtzz.png" alt="variouss-env-test-in-blazor-iaogtzz" />



## AccÃ¨s Ã  l'`Environment` et aux diffÃ©rents `appsettings`

### `ASPNETCORE_ENVIRONMENT`

On accÃ¨de Ã  l'environnement avec `Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")` dans un composant `Blazor`.

```react
@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Production")
{
    <p>Je suis dans l'environnement de Production</p>
}
```

Dans `Program.cs`, on a diffÃ©rent `helpers` :

```cs
if(app.Environment.IsDevelopment()) Console.WriteLine("Test ddevelopment");
if(app.Environment.IsProduction()) Console.WriteLine("Test production");
```

Par dÃ©faut `asp.net` a trois environnements (valeur pour `ASPNETCORE_ENVIRONMENT`) dÃ©finis:

- `Development`
- `Staging`
- `Production`

Si on veut crÃ©er un nouvel environnement, `Test` par exemple on a :

```cs
if(app.Environment.IsEnvironment("Test")) Console.WriteLine("Test environment");
```



### `IConfiguration`

C'est en injectant `IConfiguration Configuration` que l'on accÃ¨de aux donnÃ©es contenues dans les diffÃ©rents `appsettings`.

 `asp.net` va charger `appsettings.<valeur de ASPNETCORE_ENVIRONMENT>.json`.

```react
@inject IConfiguration Configuration

@code
{
    string _connectionString = string.Empty;
    string _forAll = string.Empty;

    protected override void OnInitialized()
    {
        _connectionString = Configuration["MyConnectionString"] ?? "";
        _forAll = Configuration["MyStringForAll"] ?? "";
    }
}
```



## Tester les environnements depuis son `IDE`

Le fichier `launchSettings.json` permet de dÃ©finir les paramÃ¨tres d'exÃ©cution de l'application, notamment `ASPNETCORE_ENVIRONMENT`.

```json
{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "profiles": {
    "Test": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Test"
      }
    },
    "Development": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}
```

<img src="assets/variouss-launch-settings-define-yhjqqio.png" alt="variouss-launch-settings-define-yhjqqio" />

```json
  "$schema": "https://json.schemastore.org/launchsettings.json",
```

### ðŸ”¹ `$schema` : Fournit un lien vers le schÃ©ma `JSON` pour l'autocomplÃ©tion et la validation du fichier dans l'Ã©diteur.


```json
"commandName": "Project",
```



### ðŸ”¹ **`commandName`** : DÃ©finit le mode d'exÃ©cution.

- `"Project"` : DÃ©marre l'application en mode projet (`dotnet run`).
- D'autres valeurs possibles :
  - `"IISExpress"` : Lance avec `IIS Express`.
  - `"Executable"` : DÃ©marre une application publiÃ©e.

```json
  "dotnetRunMessages": true,
```


### ðŸ”¹ `dotnetRunMessages` :

`true` â†’ Affiche les logs de dÃ©marrage dans la console (dotnet run).

`false` â†’ DÃ©sactive ces messages.



> ## ExÃ©cuter un `profile` en `CLI`
>
> ### `--launch-profile`
>
> ```bash
> dotnet run --launch-profile Production
> ```
>
> <img src="assets/app-blaazor-run-in-production-plhrcs.png" alt="app-blaazor-run-in-production-plhrcs" />
>
> ### PrioritÃ© par dÃ©faut
>
> **`dotnet run` sans argument** Utilise **le premier profil** dÃ©fini dans `launchSettings.json`. la valeur premiÃ¨re valeur de `ASPNETCORE_ENVIRONMENT` dans le fichier `launchSettings` Ã©crasera donc la valeur dÃ©finie par :
>
> ```bash 
> export ASPNETCORE_ENVIRONMENT=Production
> ```
>
> Je peus aussi utiliser `--no-launch-profile` pour ne pas tenir compte de `launchSettings.json` :
>
> ```bash
> echo $ASPNETCORE_ENVIRONMENT        
> Production
> 
> dotnet run --no-launch-profile 
> ```
>
> Mon application tourne en `Production`
>
> ```bash
> dotnet run
> ```
>
> Mon application tourne en `Test`, qui est le premier `profile` dÃ©fini dans `launchSettings.json`.
