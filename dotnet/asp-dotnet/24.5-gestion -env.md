# 24.5 gestion des diff√©rents environnements

## Plusieurs `appsettings.json`

On peut cr√©er autant de `appsettings.json` que d'environnements qu'on d√©sire :

<img src="assets/all-appsettings-json-ceated-frqtyuj.png" alt="all-appsettings-json-ceated-frqtyuj" />

Si `ASPNETCORE_ENVIRONMENT` vaut `Test` par exemple, les valeurs de `appsettings.json` et `appsettings.Test.json` seront lues. Si une cl√© est identique et pr√©sente dans les deux fichiers, le plus sp√©cifique √©crase le plus g√©n√©rique. Ici `appsettings.Test.json` √©crase `appsettings.json`.

`appsettings.json`

```json
{
  "MyConnectionString" : "Connection String de unknow ???",
  "AllowedHosts": "*",
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "MyStringForAll": "je suis disponible depuis tous les environnements"
}
```



`appsettings.Test.json`

```json
{
  "MyConnectionString" : "Connection String de Test"
}
```

Ici `Configuration["MyConnectionString"]` vaudra donc `"Connection String de Test"`.

### Test dans `Blazor Server`

```react
@page "/"

@inject IConfiguration Configuration


Connection string : @_connectionString<br/>
for all : @_forAll

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Test")
{
    <p>Je suis dans l'environnement de Test</p>
}

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development")
{
    <p>Je suis dans l'environnement de Development</p>
}

@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Production")
{
    <p>Je suis dans l'environnement de Production</p>
}


@code
{
    string _connectionString = string.Empty;
    string _forAll = string.Empty;

    protected override void OnInitialized()
    {
        _connectionString = Configuration["MyConnectionString"] ?? "";
        _forAll = Configuration["MyStringForAll"] ?? "";
    }
}
```

<img src="assets/variouss-env-test-in-blazor-iaogtzz.png" alt="variouss-env-test-in-blazor-iaogtzz" />



## Acc√®s √† l'`Environment` et aux diff√©rents `appsettings`

### `ASPNETCORE_ENVIRONMENT`

On acc√®de √† l'environnement avec `Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")` dans un composant `Blazor`.

```react
@if (Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Production")
{
    <p>Je suis dans l'environnement de Production</p>
}
```

Dans `Program.cs`, on a diff√©rent `helpers` :

```cs
if(app.Environment.IsDevelopment()) Console.WriteLine("Test ddevelopment");
if(app.Environment.IsProduction()) Console.WriteLine("Test production");
```

Par d√©faut `asp.net` a trois environnements (valeur pour `ASPNETCORE_ENVIRONMENT`) d√©finis:

- `Development`
- `Staging`
- `Production`

Si on veut cr√©er un nouvel environnement, `Test` par exemple on a :

```cs
if(app.Environment.IsEnvironment("Test")) Console.WriteLine("Test environment");
```



### `IConfiguration`

C'est en injectant `IConfiguration Configuration` que l'on acc√®de aux donn√©es contenues dans les diff√©rents `appsettings`.

 `asp.net` va charger `appsettings.<valeur de ASPNETCORE_ENVIRONMENT>.json`.

```react
@inject IConfiguration Configuration

@code
{
    string _connectionString = string.Empty;
    string _forAll = string.Empty;

    protected override void OnInitialized()
    {
        _connectionString = Configuration["MyConnectionString"] ?? "";
        _forAll = Configuration["MyStringForAll"] ?? "";
    }
}
```



## Tester les environnements depuis son `IDE`

Le fichier `launchSettings.json` permet de d√©finir les param√®tres d'ex√©cution de l'application, notamment `ASPNETCORE_ENVIRONMENT`.

```json
{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "profiles": {
    "Test": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Test"
      }
    },
    "Development": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "Production": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5291",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Production"
      }
    }
  }
}
```

<img src="assets/variouss-launch-settings-define-yhjqqio.png" alt="variouss-launch-settings-define-yhjqqio" />

```json
  "$schema": "https://json.schemastore.org/launchsettings.json",
```

### üîπ `$schema` : Fournit un lien vers le sch√©ma `JSON` pour l'autocompl√©tion et la validation du fichier dans l'√©diteur.


```json
"commandName": "Project",
```



### üîπ **`commandName`** : D√©finit le mode d'ex√©cution.

- `"Project"` : D√©marre l'application en mode projet (`dotnet run`).
- D'autres valeurs possibles :
  - `"IISExpress"` : Lance avec `IIS Express`.
  - `"Executable"` : D√©marre une application publi√©e.

```json
  "dotnetRunMessages": true,
```


### üîπ `dotnetRunMessages` :

`true` ‚Üí Affiche les logs de d√©marrage dans la console (dotnet run).

`false` ‚Üí D√©sactive ces messages.



> ## Ex√©cuter un `profile` en `CLI`
>
> ### `--launch-profile`
>
> ```bash
> dotnet run --launch-profile Production
> ```
>
> <img src="assets/app-blaazor-run-in-production-plhrcs.png" alt="app-blaazor-run-in-production-plhrcs" />
>
> ### Priorit√© par d√©faut
>
> **`dotnet run` sans argument** Utilise **le premier profil** d√©fini dans `launchSettings.json`. la valeur premi√®re valeur de `ASPNETCORE_ENVIRONMENT` dans le fichier `launchSettings` √©crasera donc la valeur d√©finie par :
>
> ```bash 
> export ASPNETCORE_ENVIRONMENT=Production
> ```
>
> Je peus aussi utiliser `--no-launch-profile` pour ne pas tenir compte de `launchSettings.json` :
>
> ```bash
> echo $ASPNETCORE_ENVIRONMENT        
> Production
> 
> dotnet run --no-launch-profile 
> ```
>
> Mon application tourne en `Production`
>
> ```bash
> dotnet run
> ```
>
> Mon application tourne en `Test`, qui est le premier `profile` d√©fini dans `launchSettings.json`.