# 02.1 Implémentation du `Repository`





## `ContactRepository`

```cs
public class ContactRepository : IContactRepository
{ 
    // PATTERN Personnel inspiré par Damian Edwards, j'espère que c'est une bonne pratique
    private IDbConnection _db;
    
    public ContactRepository(SqlConnection connection)
    {
        _db = connection;
    }
```

### `GET BY ID`
```cs
public Contact GetById(int id)
{
    var sql = @"SELECT * 
                    FROM Contacts 
                    WHERE Id = @Id";

    return _db.Query<Contact>(sql, new { id }).SingleOrDefault();
    // SingleOrDefault a du sens pour un id plus que FirstOrDefault
}
```

### `GET ALL`
```cs
public List<Contact> GetAll()
{
    var sql = "SELECT * FROM Contacts";

    return _db.Query<Contact>(sql).ToList();
}
```

### `ADD`
```cs
public Contact Add(Contact contact)
{
    var sql = @"INSERT INTO Contacts
                (FirstName, LastName, Email, Company, Title) 
                VALUES 
                (@FirstName, @LastName, @Email, @Company, @Title);
                SELECT CAST(SCOPE_IDENTITY() as int)";

    var id = _db.QueryFirst<int>(sql, contact);
    contact.Id = id;

    return contact;
}
```

### `UPDATE`
```cs
public Contact Update(Contact contact)
{
    var sql = @"UPDATE Contacts
                SET FirstName = @FirstName, 
                    LastName = @LastName,
                    Email = @Email,
                    Company = @Company,
                    Title = @Title
                WHERE Id = @Id";
    var rowsAffected = _db.Execute(sql, contact);
    return new UpdateContactDto(contact, rowsAffected);
}
```

### `DELETE`
```cs
public void Delete(int id)
{
    var sql = @"DELETE FROM Contacts WHERE Id = @Id";
    return _db.Execute(sql, new{ id });
}    
```



## Injection du `repository`

```cs
// Program.cs

var connectionString = builder.Configuration.GetConnectionString("HukarConnection");

builder.Services.AddScoped(_ => new SqlConnection(connectionString));
builder.Services.AddScoped<IContactRepository, ContactRepository>();
```



## Utilisation dans un `Endpoint`

```cs
app.MapGet("/contact/{id:int}", GetContactById);
app.MapGet("/contact", GetAllContact);
app.MapPost("/contact", AddContact);
app.MapPut("/contact", UpdateContact);
app.MapDelete("/contact/{id:int}", DeleteContact);
```

### `GET CONTACT BY ID`
```cs
IResult GetContactById(int id, IContactRepository repo) 
    => repo.GetById(id) is Contact contact ? Ok(contact) : NotFound();
```
### `GET ALL CONTACT`
```cs
IResult GetAllContact(IContactRepository repo) => Ok(repo.GetAll());
```

### `ADD CONTACT`
```cs
IResult AddContact(Contact contact, IContactRepository repo)
{
    repo.Add(contact);

    return Created($"/contact/{contact.Id}", contact);
}
```

### `UPDATE CONTACT`
```cs
IResult UpdateContact(Contact contact, IContactRepository repo)
{
    var response = repo.Update(contact);

    if (response.rowsAffected == 0)
    {
        return NotFound();
    }

    return NoContent();
}
```

### `DELETE CONTACT`
```cs
IResult DeleteContact(int id, IContactRepository repo)
{
    var rowsAffected = repo.Delete(id);

    if(rowsAffected == 0)
    {
        return NotFound();
    }

    return NoContent();
}
```

