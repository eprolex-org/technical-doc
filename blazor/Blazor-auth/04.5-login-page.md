# 04.5 `Login` page



## Pourquoi cela ne fonctionne pas avec `HttpClient`

On pourrait faire un `Formulaire`  (ici juste un `bouton` de connexion) g√©r√© programmatiquement depuis le server `Blazor` :

```ruby
@foreach (var utilisateur in utilisateurs)
{
        <MudButton
            Variant="Variant.Filled"
            Color="Color.Secondary"
            OnClick="() => LogUtilisateur(utilisateur)">
            Log @utilisateur.Name
        </MudButton>

}
```

```cs
async Task LogUtilisateur(Utilisateur utilisateur)
{
    var client = Factory.CreateClient("id-api");

    await client.PostAsJsonAsync(
        $"signin2?ReturnUrl={ReturnUrl}", 
        utilisateur
    );
}
```

On a cette s√©quence :

<img src="assets/sequence-http-client-bad-circle-ijhdgfiokjhytgfbcbcbcbcbc.png" alt="sequence-http-client-bad-circle-ijhdgfiokjhytgfbcbcbcbcbc" />

Le `Cookie` est renvoy√© √† l'application `Blazor` mais jamais au navigateur et ne sera pas non plus plac√© dans la requ√™te `GET` de redirection. L'utilisateur ne pourra pas se connecter.

Le navigateur n'est jamais contact√© et l'utilisateur reste sur la m√™me page.

> ## R√©glage du `Redirect` automatique
>
> ```cs
> builder.Services.AddHttpClient("id-api", options =>
> {
>     options.BaseAddress = new Uri(
>         builder.Configuration["BaseUrl"] ?? throw new Exception("appSettings baseUrl is mandatory")
>     );
> }).ConfigurePrimaryHttpMessageHandler(() => new HttpClientHandler { AllowAutoRedirect = false }); // par d√©faut true
> ```



## Solution : `<form method="POST">`

<img src="assets/sequence-form-post-login-plffdgterscxwqxqwcaal.png" alt="sequence-form-post-login-plffdgterscxwqxqwcaal" />

Ici le `Cookie` est bien envoy√© au navigateur et celui-ci le joint √† chacune de ses requ√™tes.

```ruby
@foreach (var utilisateur in utilisateurs)
{
    <form 
    	method="post" 
    	action="@($"/signin?ReturnUrl={ReturnUrl}")">
        
        <AntiforgeryToken/>
        
        <Input type="hidden" name="Id" value="@utilisateur.Id"/>
        <Input type="hidden" name="Name" value="@utilisateur.Name"/>

        <MudButton
            Variant="Variant.Filled"
            ButtonType="ButtonType.Submit"
            Color="Color.Info">
            signin @utilisateur.Name
        </MudButton>
    </form>
}
```

La redirection va recharger la page et cr√©er une nouvelle session `SignalR` dans `Blazor` en lui passant le `Cookie` d'authentification.

`<AntiforgeryToken/>` fonctionne tr√®s bien et est obligatoire. Il ajoute un champ cach√© :

```html
<input type="hidden" name="__RequestVerificationToken" value="CfDJ8JhGZH6ErBFKsQ7MKmlSBgPizUr9q80oUTr7Ir-UQyTo2tw7pdIcd_p7G_DQ1xAw6qXGnEBRqogabXK9cIhCMiBGmhhQoTrsf9G5h3G5Js3NqaBkQ6ytbbqJceb0x3Qspzx3FYMvKiLP-8RN7nNYiEqiylWcPtlPakGCSEoZf_zQwCQ5EF_QgGJ5wenAFs4Xlg">
```

Le `middleware` associ√© est plac√© dans `program.cs` :
```cs
app.UseAntiforgery();
```



> # üìå **Construction d'`URL`** avec `NavigationManager`
>
> | √âl√©ment                | Type   | Renvoie               | Exemple                                     |
> | ---------------------- | ------ | --------------------- | ------------------------------------------- |
> | `Uri`                  | string | URL compl√®te courante | `https://localhost:5001/orders?x=1`         |
> | `BaseUri`              | string | Racine de l‚Äôapp       | `https://localhost:5001/`                   |
> | `ToAbsoluteUri()`      | Uri    | URL absolue           | `/products` ‚Üí `https://‚Ä¶/products`          |
> | `ToBaseRelativePath()` | string | Chemin relatif        | `https://‚Ä¶/products/list` ‚Üí `products/list` |
> | `NavigateTo()`         | void   | Change l‚ÄôURL          | `NavigateTo("/login")`                      |

